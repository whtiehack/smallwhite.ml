<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>luaplus 与官方文档慢慢扯(五) | smallwhite's Blog</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="slog, smallwhite's blog, 后端博客, 后端, 程序员, 后端开发, 全栈开发, node.js, javascript, golang, c/c++, pinus, pomelo, typescript"><meta name="description" content="smallwhite's Blog 日常学习与兴趣交流的个人博客"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="https://smallwhite.ml/pub/uncategorized/luaplus-yu-guan-fang-wen-dang-man-man-che-wu.html"><link rel="icon" type="image/png" href="/favicon.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="smallwhite's Blog"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?ffbfeacabe5e673d7a972c8b3977806f";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/loader.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="smallwhite's Blog" alt="smallwhite's Blog"><img src="/favicon.png" alt="smallwhite's Blog"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/bookmark" alt="书签" title="书签">书签</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><header class="post__info"><h1 class="post__title">luaplus 与官方文档慢慢扯(五)</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/">undefined</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2011-05-08</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/CSDN迁移/">CSDN迁移</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-eye"></i><ul class="mark__list clearfix"><li id="busuanzi_container_page_pv" class="mark__item"><span id="busuanzi_value_page_pv"></span>次</li></ul></div></div></header><div class="post__content"><h3 id="Registering-Callbacks-注册lua-c函数"><a href="#Registering-Callbacks-注册lua-c函数" class="headerlink" title="Registering Callbacks(注册lua c函数)"></a>Registering Callbacks(注册lua c函数)</h3><p>函数原型</p><p>int Callback(LuaState* state);</p><p>作为一种替代机制 lua stack 是通过LuaStack类提供的</p><p>LuaPlus的回调函数使用了一种简单的函数机制 可以让全局函数 静态函数 非虚成员函数 与虚成员函数 成为回调函数</p><p>下面是一个示例 例子很简单就不注释了 (唯一需要注意的是 LuaStack args(state);)</p><p>static int LS_LOG(LuaState<em> state) { printf(“In static function/n”); return 0; } class Logger { public: int LS_LOGMEMBER(LuaState</em> state) { LuaStack args(state);//需要注意这里哦 printf(“In member function. Message: %s/n”, args[1].GetString()); return 0; } virtual int LS_LOGVIRTUAL(LuaState* state) { printf(“In virtual member function/n”); return 0; } }; LuaObject globalsObj = state-&gt;GetGlobals(); globalsObj.Register(“LOG”, LS_LOG); state-&gt;DoString(“LOG()”); Logger logger; globalsObj.Register(“LOGMEMBER”, logger, &amp;Logger::LS_LOGMEMBER); state-&gt;DoString(“LOGMEMBER(‘The message’)”); globalsObj.Register(“LOGVIRTUAL”, logger, &amp;Logger::LS_LOGVIRTUAL); state-&gt;DoString(“LOGVIRTUAL()”);</p><p>使用 Register() 函数注册回调函数.</p><p>LuaObject 提供了几种重载的 Register() 函数:</p><p>void Register( const char<em> funcName, lua_CFunction function, int nupvalues = 0 ); void Register( const char</em> funcName, int (<em>func)(LuaState</em>), int nupvalues = 0 ); void Register( const char<em> funcName, const Callee&amp; callee, int (Callee::</em>func)(LuaState*), int nupvalues = 0 );</p><h3 id="Registering-Object-Dispatch-Functors-注册一个c-类到lua"><a href="#Registering-Object-Dispatch-Functors-注册一个c-类到lua" class="headerlink" title="Registering Object Dispatch Functors(注册一个c++类到lua)"></a>Registering Object Dispatch Functors(注册一个c++类到lua)</h3><p>虽然Register() 可以注册 c++类成员函数 但是他的第二个参数需要提供一个类对象</p><p>但是内部调用成员函数时候 this指针是一个常量 所以 Register()函数不是适合镜像c++类到lua中</p><p>this指针的问题 是通过 RegisterObjectFunctor() 函数解决的</p><p>官方文档原文</p><hr><p>Even though <code>Register()</code> can dispatch to C++ member functions, it uses a ‘this’ pointer as provided by the second argument passed to the function. The ‘this’ pointer is constant, and <code>Register()</code> is not suited for mirroring class hierarchies in Lua.</p><p>The solution to the ‘this’ pointer issue is through <code>RegisterObjectFunctor()</code> . It is a specialized form of <code>Register()</code> where a ‘this’ pointer isn’t provided during the closure registration. Instead, it is retrieved from either the calling userdata or the calling table’s <code>__object</code> member, which must be a full or light userdata.</p><hr><p>下面 是实现2个c++类到lua的例子</p><p>class MultiObject { public: MultiObject(int num) : m_num(num) { } int Print(LuaState* state) { printf(“%d/n”, m_num); return 0; } void Print2(int num) { printf(“%d %d/n”, m_num, num); } protected: int m_num; }; //注册一个metatable LuaObject metaTableObj = state-&gt;GetGlobals().CreateTable(“MultiObjectMetaTable”); metaTableObj.SetObject(“__index”, metaTableObj);//设置metatable是他自己 metaTableObj.RegisterObjectFunctor(“Print”, &amp;MultiObject::Print);//在table内注册一个 print函数 //现在 我们在lua内实现两个对象 obj1 obj2 MultiObject obj1(10); LuaObject obj1Obj = state-&gt;BoxPointer(&amp;obj1); obj1Obj.SetMetaTable(metaTableObj); state-&gt;GetGlobals().SetObject(“obj1”, obj1Obj); MultiObject obj2(20); LuaObject obj2Obj = state-&gt;BoxPointer(&amp;obj2); obj2Obj.SetMetaTable(metaTableObj); state-&gt;GetGlobals().SetObject(“obj2”, obj2Obj); //两个c++对象已经设置好了 现在测试下 state-&gt;DoString(“obj1:Print() ; print(obj1)”); state-&gt;DoString(“obj2:Print() ; print(obj2)”); // 10 // userdata: 002EB940 // 20 // userdata: 002EB9D0</p><p>上面的obj1 和 obj2 是作为 userdata 然后设置它的metatables 的方法创建的<br>另一种方法是将代表的c++对象的tuserdata作为表的成员 <strong>object<br>LuaObject table1Obj = state-&gt;GetGlobals().CreateTable(“table1”); table1Obj.SetLightUserData(“</strong>object”, &amp;obj1); table1Obj.SetMetaTable(metaTableObj); LuaObject table2Obj = state-&gt;GetGlobals().CreateTable(“table2”); table2Obj.SetLightUserData(“__object”, &amp;obj2); table2Obj.SetMetaTable(metaTableObj); state-&gt;DoString(“table1:Print()”); state-&gt;DoString(“table2:Print()”);</p><h3 id="Registering-Functions-Directly-直接注册普通函数"><a href="#Registering-Functions-Directly-直接注册普通函数" class="headerlink" title="Registering Functions Directly(直接注册普通函数)"></a>Registering Functions Directly(直接注册普通函数)</h3><p>LuaPlus通过RegisterDirect() 可以直接注册c++函数</p><p>float Add(float num1, float num2) { return num1 + num2; } LuaStateOwner state; state-&gt;GetGlobals().RegisterDirect(“Add”, Add); state-&gt;DoString(“print(Add(10, 5))”);</p><p>以这种方式注册的函数 函数可以是任何形式的 内部会自动进行函数参数的类型检查</p><p>如果lua调用函数 传入的参数无效 则触发 luaL_argassert 导致调用失败</p><p>例如 state-&gt;DoString(“print(Add(10, ‘Hello’))”); 这样就导致失败了</p><p>全局函数可以这样注册 而成员函数也同样可以这样注册</p><p>void LOG(const char<em> message) { printf(“In global function: %s/n”, message); } class Logger { public: void LOGMEMBER(const char</em> message) { printf(“In member function: /n”, message); } virtual void LOGVIRTUAL(const char* message) { printf(“In virtual member function: %s/n”, message); } }; LuaObject globalsObj = state-&gt;GetGlobals(); globalsObj.RegisterDirect(“LOG”, LOG); Logger logger; globalsObj.RegisterDirect(“LOGMEMBER”, logger, &amp;Logger::LOGMEMBER); globalsObj.RegisterDirect(“LOGVIRTUAL”, logger, &amp;Logger::LOGVIRTUAL); state-&gt;DoString(“LOG(‘Hello’)”); state-&gt;DoString(“LOGMEMBER(‘Hello’)”); state-&gt;DoString(“LOGVIRTUAL(‘Hello’)”);</p><p>直接注册的函数在目前版本中最多只支持7个参数</p><h3 id="Object-Dispatch-to-Directly-Called-C-Member-Functions-注册普通c-成员函数"><a href="#Object-Dispatch-to-Directly-Called-C-Member-Functions-注册普通c-成员函数" class="headerlink" title="Object Dispatch to Directly Called C++ Member Functions(注册普通c++成员函数)"></a>Object Dispatch to Directly Called C++ Member Functions(注册普通c++成员函数)</h3><p>官方文档原文</p><hr><p>Even though <code>RegisterDirect()</code> can dispatch directly to C++ member functions, it uses a ‘this’ pointer as provided by the second argument passed to the function. The ‘this’ pointer is constant, and <code>RegisterDirect()</code> is not suited for mirroring class hierarchies in Lua.</p><p>The solution to the ‘this’ pointer issue is through <code>RegisterObjectDirect()</code> . It is a specialized form of RegisterDirect() where a ‘this’ pointer isn’t provided during the closure registration. Instead, it is retrieved from either the calling userdata or the calling table’s <code>__object</code> member, which must be a full or light userdata. The techniques presented in this section mirror closely the <code>RegisterObjectFunctor()</code> description above.</p><hr><p>使用上一个注册c++对象的那个示例</p><p>向metatable内直接注册普通的c++成员函数</p><p>metaTableObj.RegisterObjectDirect(“Print2”, (MultiObject*)0, &amp;MultiObject::Print2);</p><p>测试</p><p>state-&gt;DoString(“obj1:Print2(5)”); state-&gt;DoString(“obj2:Print2(15)”); state-&gt;DoString(“table1:Print2(5)”); state-&gt;DoString(“table2:Print2(15)”);</p><h3 id="Unregistering-Callbacks-撤销已经注册到lua内的对象"><a href="#Unregistering-Callbacks-撤销已经注册到lua内的对象" class="headerlink" title="Unregistering Callbacks(撤销已经注册到lua内的对象)"></a>Unregistering Callbacks(撤销已经注册到lua内的对象)</h3><p>注销回调非常简单 只需将其设置为nil</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">globalsObj.SetNil(&quot;LOG&quot;);</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>###</p><div class="post-announce">感谢您的阅读，本文由 <a href="https://smallwhite.ml">smallwhite's Blog</a> 版权所有。如若转载，请注明出处：smallwhite's Blog（<a href="https://smallwhite.ml/pub/uncategorized/luaplus-yu-guan-fang-wen-dang-man-man-che-wu.html">https://smallwhite.ml/pub/uncategorized/luaplus-yu-guan-fang-wen-dang-man-man-che-wu.html</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/pub/uncategorized/luaplus-yu-guan-fang-wen-dang-man-man-che-liu.html" title="luaplus 与官方文档慢慢扯(六)"><i class="iconfont icon-prev"></i>luaplus 与官方文档慢慢扯(六)</a></div><div class="post__prev post__prev--right"><a href="/pub/uncategorized/luaplus-yu-guan-fang-wen-dang-man-man-che-si.html" title="luaplus 与官方文档慢慢扯(四)">luaplus 与官方文档慢慢扯(四)<i class="iconfont icon-next"></i></a></div></div></div></article><div id="comment-container"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">smallwhite's Blog 日常学习与兴趣交流的个人博客</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/win32/">win32</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/pinus/">pinus</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/nodejs/">nodejs</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/linux/">linux</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/jenkins/">jenkins</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/ide/">ide</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/http2/">http2</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/go/">go</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/docker/">docker</a><span class="block-list-count">1</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/pub/http2/golang-http-403-forbidden-disable-http2.html" title="golang http请求返回403 Forbidden - 禁用http2解决"><div class="item__cover"><img src="/programming.png" alt="golang http请求返回403 Forbidden - 禁用http2解决"></div><div class="item__info"><h3 class="item__title">golang http请求返回403 Forbidden - 禁用http2解决</h3><span class="item__text">2020-11-17</span></div></a></li><li class="latest-post-item"><a href="/pub/linux/convert-ssh-key-format-rsa-openssh.html" title="转换key格式OPENSSH PRIVATE KEY 转换为 RSA PRIVATE KEY"><div class="item__cover"><img src="/programming.png" alt="转换key格式OPENSSH PRIVATE KEY 转换为 RSA PRIVATE KEY"></div><div class="item__info"><h3 class="item__title">转换key格式OPENSSH PRIVATE KEY 转换为 RSA PRIVATE KEY</h3><span class="item__text">2020-11-07</span></div></a></li><li class="latest-post-item"><a href="/pub/jenkins/install-jenkins-use-mirrors.html" title="使用镜像安装jenkins"><div class="item__cover"><img src="/programming.png" alt="使用镜像安装jenkins"></div><div class="item__info"><h3 class="item__title">使用镜像安装jenkins</h3><span class="item__text">2020-04-03</span></div></a></li><li class="latest-post-item"><a href="/pub/nodejs/compare-go-nodejs-csharp.html" title="go c nodejs csharp 可能不太准确的性能测试"><div class="item__cover"><img src="/programming.png" alt="go c nodejs csharp 可能不太准确的性能测试"></div><div class="item__info"><h3 class="item__title">go c nodejs csharp 可能不太准确的性能测试</h3><span class="item__text">2019-11-15</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/CSDN迁移/">CSDN迁移</a></li><li class="tag-item"><a class="tag-link" href="/tags/c/">c++</a></li><li class="tag-item"><a class="tag-link" href="/tags/csharp/">csharp</a></li><li class="tag-item"><a class="tag-link" href="/tags/docker/">docker</a></li><li class="tag-item"><a class="tag-link" href="/tags/go/">go</a></li><li class="tag-item"><a class="tag-link" href="/tags/golang/">golang</a></li><li class="tag-item"><a class="tag-link" href="/tags/http2/">http2</a></li><li class="tag-item"><a class="tag-link" href="/tags/idea/">idea</a></li><li class="tag-item"><a class="tag-link" href="/tags/javascript/">javascript</a></li><li class="tag-item"><a class="tag-link" href="/tags/jenkins/">jenkins</a></li><li class="tag-item"><a class="tag-link" href="/tags/jetbrains/">jetbrains</a></li><li class="tag-item"><a class="tag-link" href="/tags/license/">license</a></li><li class="tag-item"><a class="tag-link" href="/tags/linux/">linux</a></li><li class="tag-item"><a class="tag-link" href="/tags/mirrors/">mirrors</a></li><li class="tag-item"><a class="tag-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-item"><a class="tag-link" href="/tags/pinus/">pinus</a></li><li class="tag-item"><a class="tag-link" href="/tags/pomelo/">pomelo</a></li><li class="tag-item"><a class="tag-link" href="/tags/proxy/">proxy</a></li><li class="tag-item"><a class="tag-link" href="/tags/win32/">win32</a></li><li class="tag-item"><a class="tag-link" href="/tags/windows/">windows</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text"></p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>https://github.com/whtiehack</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>smallwhite110@gmail.com</span></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">友情链接</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://github.com/whtiehack" title="smallwhite's Github" target="_blank">Github</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">构建工具</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Blog theme" target="_blank">Theme</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="/" target="_blank">smallwhite</a> 2019 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="/" target="_blank">smallwhite</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/whtiehack" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:smallwhite110@gmail.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="/js/md5.min.js"></script><script>var tags=["CSDN迁移"],gitalk=new Gitalk({clientID:"afe80ed401fed3bea37a",clientSecret:"e9d739d3b614ac49d15e8e64dc9006c2c14baa02",repo:"smallwhite.ml",owner:"whtiehack",admin:["whtiehack"],labels:tags,id:new Date(130479234e4).toISOString()});gitalk.render("comment-container")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>