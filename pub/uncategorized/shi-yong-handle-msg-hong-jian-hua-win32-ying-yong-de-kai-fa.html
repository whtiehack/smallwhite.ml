<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>使用HANDLE_MSG宏简化Win32应用的开发 | smallwhite's Blog</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="slog, smallwhite's blog, 后端博客, 后端, 程序员, 后端开发, 全栈开发, node.js, javascript, golang, c/c++, pinus, pomelo, typescript"><meta name="description" content="smallwhite's Blog 日常学习与兴趣交流的个人博客"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="https://smallwhite.ml/pub/uncategorized/shi-yong-handle-msg-hong-jian-hua-win32-ying-yong-de-kai-fa.html"><link rel="icon" type="image/png" href="/favicon.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="smallwhite's Blog"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?ffbfeacabe5e673d7a972c8b3977806f";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/loader.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="smallwhite's Blog" alt="smallwhite's Blog"><img src="/favicon.png" alt="smallwhite's Blog"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/bookmark" alt="书签" title="书签">书签</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><header class="post__info"><h1 class="post__title">使用HANDLE_MSG宏简化Win32应用的开发</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/">undefined</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2011-08-17</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/CSDN迁移/">CSDN迁移</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-eye"></i><ul class="mark__list clearfix"><li id="busuanzi_container_page_pv" class="mark__item"><span id="busuanzi_value_page_pv"></span>次</li></ul></div></div></header><div class="post__content"><p><a href="http://blog.csdn.net/tanghw/article/details/5438093" target="_blank" rel="noopener">http://blog.csdn.net/tanghw/article/details/5438093</a></p><p>Win32应用中的回调函数WndProc用于接收Windows向应用程序直接发送的消息，以及响应消息。大多情况下，我们这样编写代码：</p><p><a href="http://blog.csdn.net/tanghw/article/details/5438093#" target="_blank" rel="noopener">view plain</a></p><ol><li>LRESULT CALLBACK WndProc(HWND hWnd,</li><li>UINT message,</li><li>WPARAM wParam,</li><li>LPARAM lParam )</li><li>{</li><li>int cxClient, cyClient;</li><li>PAINTSTRUCT ps;</li><li>HDC hdc;</li><li>switch( message )</li><li>{</li><li>case WM_SIZE:</li><li>cxClient = LOWORD(lParam);</li><li>cyClient = HIWORD(lParam);</li><li>break;</li><li>case WM_PAINT:</li><li>hdc = BeginPaint( hWnd, &amp;ps );</li><li>EndPaint( hWnd, &amp;ps );</li><li>break;<br></li><li>case WM_DESTROY:</li><li>PostQuitMessage( 0 );</li><li>break;</li><li>}</li><li>return DefWindowProc( hWnd, message, wParam, lParam );</li><li>}</li></ol><p>这种方式通过switch分支语句分理处理各个消息，结构简单明了。但有2个问题：</p><ol><li>在所处理的消息多了后，全部代码都集中于一个switch语句中，变量容易相互污染，且代码很长，不容易定位代码。</li><li>大多数的消息都有相应的WPARAM、LPARAM参数，但对于每个消息，其WPARAM、LPARAM参数的具体内容又不一致。就像上面WM_SIZE中的代码，我们怎么知道cyClient、cyClient的信息就放在lParam而不是wParam中，且cxClient的信息在lParam的低位，cyClient的信息在lParam的高位？我们需要随时查询SDK文档以了解这两个参数中各有什么含义，以及如何恰当地将这些参数抽取出来。不管怎样，上面的代码实际上就是个让人一团雾水的魔术代码(Magic Code).WindowsX.h定义了许多宏，可以帮助我们解决上述这些问题。其中HANDLE_MSG宏可以大大简化Win32开发。下面我们先看使用HANDLE_MSG宏后的代码：</li></ol><p><a href="http://blog.csdn.net/tanghw/article/details/5438093#" target="_blank" rel="noopener">view plain</a></p><ol><li>void OnSize(HWND hwnd, UINT state, int cx, int cy)</li><li>{</li><li>}</li><li>void OnPaint(HWND hWnd)</li><li>{</li><li>PAINTSTRUCT ps;</li><li>HDC hdc;</li><li>hdc = BeginPaint( hWnd, &amp;ps );</li><li>EndPaint( hWnd, &amp;ps );</li><li>}</li><li>void OnWinDestroy(HWND hWnd)</li><li>{</li><li>PostQuitMessage(0);</li><li>}</li><li>LRESULT CALLBACK WndProc(HWND hWnd,</li><li>UINT message,</li><li>WPARAM wParam,</li><li>LPARAM lParam )</li><li>{</li><li>switch( message )</li><li>{</li><li>HANDLE_MSG(hWnd, WM_SIZE, OnSize);</li><li>HANDLE_MSG(hWnd, WM_PAINT, OnPaint);</li><li>HANDLE_MSG(hWnd, WM_DESTROY, OnWinDestroy);</li><li>}</li><li>return DefWindowProc( hWnd, message, wParam, lParam );</li><li>}</li></ol><p>与使用HANDLE_MSG宏之前的代码相比，我们根本不需使用LOWORD、HIWORD来提取cxCleint及cyClient的信息，OnSize函数的参数已经有cx及cy，而且还传进一个表示窗口变化类型的参数state，如SIZE_RESTORED, SIZE_MAXSHOW等。ps与hdc这两个变量移至OnPaint函数中而成为真正的局域变量。在switch分支语句中，对于每一个消息，都使用HANDLE_MSG宏清晰地将消息与消息处理函数对应起来，代码非常简洁。而无论是在消息处理函数，或是switch分支中，我们均无需显式地加上break语句。</p><p>下面我们来看看HANDLE_MSG宏是如何做到这一点的。HANDLE_MSG宏的定义如下所示：</p><p><a href="http://blog.csdn.net/tanghw/article/details/5438093#" target="_blank" rel="noopener">view plain</a></p><ol><li>#define HANDLE_MSG(hwnd, message, fn) /</li><li>case (message): return HANDLE_##message((hwnd), (wParam), (lParam), (fn))</li></ol><p>HANDLE_MSG(hwnd, message, fn)是宏的签名。hwnd是需处理消息的窗口句柄，message是消息，fn是指向负责消息处理的函数指针。当编译器遇到此宏，将在编译时将其转换为</p><p><a href="http://blog.csdn.net/tanghw/article/details/5438093#" target="_blank" rel="noopener">view plain</a></p><ol><li>case (message): return HANDLE_##message((hwnd), (wParam), (lParam), (fn))</li></ol><p>的形式。##是ANSI C标准中的预处理器，用于将前后两个符号直接连接起来。因此，当message为WM_SIZE时，HANDLE_##message就变成：</p><p><a href="http://blog.csdn.net/tanghw/article/details/5438093#" target="_blank" rel="noopener">view plain</a></p><ol><li>HANDLE_WM_SIZE</li></ol><p>因此，对于</p><p><a href="http://blog.csdn.net/tanghw/article/details/5438093#" target="_blank" rel="noopener">view plain</a></p><ol><li>HANDLE_MSG(hWnd, WM_SIZE, OnSize)</li></ol><p>编译器将转换为：</p><p><a href="http://blog.csdn.net/tanghw/article/details/5438093#" target="_blank" rel="noopener">view plain</a></p><ol><li>case WM_SIZE:</li><li>return HANDLE_WM_SIZE(hwnd, wParam, lParam, OnSize)</li></ol><p>我们注意到，尽管HANDLE_MSG宏中未使用wParam及lParam参数，但展开宏后，这两个参数均加进来了。</p><p>HANDLE_WM_SIZE也是一个在WindowsX.h中定义的宏，其原型如下：</p><p><a href="http://blog.csdn.net/tanghw/article/details/5438093#" target="_blank" rel="noopener">view plain</a></p><ol><li>#define HANDLE_WM_SIZE(hwnd, wParam, lParam, fn) /</li><li>((fn)((hwnd), (UINT)(wParam), (int)(short)LOWORD(lParam), (int)(short)HIWORD(lParam)), 0L)</li></ol><p>正是在HANDLE_WM_SIZE宏中，自动将wParam, lParam的高位及低位分别抽出，作为OnSize函数的实参进行传递。</p><p>应注意，不同消息处理函数的参数列表是不一样的。如OnSize函数，其参数列表包括HWND, UINT, int, int, 而OnPaint、OnWindDestory函数均只有一个HWND参数。那么，如何声明这些消息处理函数的签名？很简单，在WindowsX.h文件中找到定义HANDLE_WM_SIZE的地方，其上面有一行注释：</p><p><a href="http://blog.csdn.net/tanghw/article/details/5438093#" target="_blank" rel="noopener">view plain</a></p><ol><li>/<em> void Cls_OnSize(HWND hwnd, UINT state, int cx, int cy) </em>/</li><li>#define HANDLE_WM_SIZE(hwnd, wParam, lParam, fn) /</li><li>((fn)((hwnd), (UINT)(wParam), (int)(short)LOWORD(lParam), (int)(short)HIWORD(lParam)), 0L)</li></ol><p>Cls_OnSize函数已经给出了函数的签名，因此，我们只需将此签名复制过来，并将Cls_OnSize更名为自己选择的函数名称即可。</p><div class="post-announce">感谢您的阅读，本文由 <a href="https://smallwhite.ml">smallwhite's Blog</a> 版权所有。如若转载，请注明出处：smallwhite's Blog（<a href="https://smallwhite.ml/pub/uncategorized/shi-yong-handle-msg-hong-jian-hua-win32-ying-yong-de-kai-fa.html">https://smallwhite.ml/pub/uncategorized/shi-yong-handle-msg-hong-jian-hua-win32-ying-yong-de-kai-fa.html</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/pub/uncategorized/yong-aheadlib-sheng-cheng-lpk-xiu-gai-liao-xia.html" title="用Aheadlib 生成lpk 修改了下"><i class="iconfont icon-prev"></i>用Aheadlib 生成lpk 修改了下</a></div><div class="post__prev post__prev--right"><a href="/pub/uncategorized/win7-hu-yan-tou-ming-zhu-ti-mei-li-win7.html" title="win7护眼透明主题 “魅力win7”">win7护眼透明主题 “魅力win7”<i class="iconfont icon-next"></i></a></div></div></div></article><div id="comment-container"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">smallwhite's Blog 日常学习与兴趣交流的个人博客</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/win32/">win32</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/pinus/">pinus</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/nodejs/">nodejs</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/jenkins/">jenkins</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/ide/">ide</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/go/">go</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/docker/">docker</a><span class="block-list-count">1</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/pub/jenkins/install-jenkins-use-mirrors.html" title="使用镜像安装jenkins"><div class="item__cover"><img src="/programming.png" alt="使用镜像安装jenkins"></div><div class="item__info"><h3 class="item__title">使用镜像安装jenkins</h3><span class="item__text">2020-04-03</span></div></a></li><li class="latest-post-item"><a href="/pub/nodejs/compare-go-nodejs-csharp.html" title="go c nodejs csharp 可能不太准确的性能测试"><div class="item__cover"><img src="/programming.png" alt="go c nodejs csharp 可能不太准确的性能测试"></div><div class="item__info"><h3 class="item__title">go c nodejs csharp 可能不太准确的性能测试</h3><span class="item__text">2019-11-15</span></div></a></li><li class="latest-post-item"><a href="/pub/go/multi-go-version.html" title="简单方法管理go多版本"><div class="item__cover"><img src="/programming.png" alt="简单方法管理go多版本"></div><div class="item__info"><h3 class="item__title">简单方法管理go多版本</h3><span class="item__text">2019-09-07</span></div></a></li><li class="latest-post-item"><a href="/pub/docker/docker-cannot-access-by-external.html" title="docker 突然不能被外网访问"><div class="item__cover"><img src="/programming.png" alt="docker 突然不能被外网访问"></div><div class="item__info"><h3 class="item__title">docker 突然不能被外网访问</h3><span class="item__text">2019-08-19</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/CSDN迁移/">CSDN迁移</a></li><li class="tag-item"><a class="tag-link" href="/tags/c/">c++</a></li><li class="tag-item"><a class="tag-link" href="/tags/csharp/">csharp</a></li><li class="tag-item"><a class="tag-link" href="/tags/docker/">docker</a></li><li class="tag-item"><a class="tag-link" href="/tags/go/">go</a></li><li class="tag-item"><a class="tag-link" href="/tags/idea/">idea</a></li><li class="tag-item"><a class="tag-link" href="/tags/javascript/">javascript</a></li><li class="tag-item"><a class="tag-link" href="/tags/jenkins/">jenkins</a></li><li class="tag-item"><a class="tag-link" href="/tags/jetbrains/">jetbrains</a></li><li class="tag-item"><a class="tag-link" href="/tags/license/">license</a></li><li class="tag-item"><a class="tag-link" href="/tags/mirrors/">mirrors</a></li><li class="tag-item"><a class="tag-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-item"><a class="tag-link" href="/tags/pinus/">pinus</a></li><li class="tag-item"><a class="tag-link" href="/tags/pomelo/">pomelo</a></li><li class="tag-item"><a class="tag-link" href="/tags/proxy/">proxy</a></li><li class="tag-item"><a class="tag-link" href="/tags/win32/">win32</a></li><li class="tag-item"><a class="tag-link" href="/tags/windows/">windows</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text"></p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>https://github.com/whtiehack</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>smallwhite110@gmail.com</span></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">友情链接</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://github.com/whtiehack" title="smallwhite's Github" target="_blank">Github</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">构建工具</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="Blog theme" target="_blank">Theme</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="/" target="_blank">smallwhite</a> 2019 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="/" target="_blank">smallwhite</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/whtiehack" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:smallwhite110@gmail.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="/js/md5.min.js"></script><script>var tags=["CSDN迁移"],gitalk=new Gitalk({clientID:"afe80ed401fed3bea37a",clientSecret:"e9d739d3b614ac49d15e8e64dc9006c2c14baa02",repo:"smallwhite.ml",owner:"whtiehack",admin:["whtiehack"],labels:tags,id:new Date(1313584976e3).toISOString()});gitalk.render("comment-container")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>